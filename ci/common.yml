default:
  tags: [ teco-dc4 ]

variables:
  http_proxy: "http://proxyappl.telecom.arg.telecom.com.ar:8080"
  https_proxy: "http://proxyappl.telecom.arg.telecom.com.ar:8080"
  no_proxy: "localhost,127.0.0.1"
  DOCKER_BUILDKIT: "1"
  COMPOSE_DOCKER_CLI_BUILD: "1"

.docker_prereqs: &docker_prereqs
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"

.build-template:
  stage: build
  image: docker:27
  services: [ docker:27-dind ]
  before_script: *docker_prereqs
  script:
    - >
      docker build --pull
      --build-arg APP_NAME=${APP_NAME}
      -t $CI_REGISTRY_IMAGE/${IMAGE_NAME}:${IMAGE_TAG}
      -t $CI_REGISTRY_IMAGE/${IMAGE_NAME}:${IMAGE_TAG}-${CI_COMMIT_SHORT_SHA}
      -f Dockerfile .
    - docker push $CI_REGISTRY_IMAGE/${IMAGE_NAME}:${IMAGE_TAG}
    - docker push $CI_REGISTRY_IMAGE/${IMAGE_NAME}:${IMAGE_TAG}-${CI_COMMIT_SHORT_SHA}

.deploy-template:
  stage: deploy
  image: $CI_REGISTRY_IMAGE/ci/docker-cli
  before_script: *docker_prereqs
  script:
    - echo "Deploy $ENV_NAME via Swarm"
    - export IMAGE_TAG="${IMAGE_TAG}"      # sin -$CI_COMMIT_SHORT_SHA
    - docker stack deploy --with-registry-auth --resolve-image changed -c deploy/docker-stack.yml "$STACK_NAME"
    #- docker stack deploy --with-registry-auth -c deploy/docker-stack.yml "$STACK_NAME"
  dependencies: []
